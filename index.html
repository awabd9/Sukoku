<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¥µé™ç´šç¶²é æ•¸ç¨</title>
    <style>
        :root {
            --grid-size: 450px;
            --main-color: #3f51b5; /* è—è‰² */
            --error-color: #f44336; /* ç´…è‰² */
            --note-color: #9e9e9e; /* ç°è‰² */
        }

        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f4f7f6;
            padding: 20px;
            margin: 0;
        }

        h1 {
            color: var(--main-color);
            margin-bottom: 20px;
        }

        .controls {
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        /* è¨ˆæ™‚å™¨å’Œè³‡è¨Šæ¬„ä½æ¨£å¼ */
        .info-panel {
            display: flex;
            justify-content: space-between;
            width: var(--grid-size);
            margin-bottom: 10px;
            font-size: 1.1em;
            font-weight: bold;
        }
        
        #timer-display { color: #2196F3; }
        .error-info { color: var(--error-color); font-weight: bold; font-size: 1.1em; }
        
        /* --- æ•¸ç¨ç›¤é¢æ¨£å¼ (Grid æ ¸å¿ƒ) --- */
        .sudoku-grid {
            display: grid; 
            grid-template-columns: repeat(9, 1fr); 
            grid-template-rows: repeat(9, 1fr);
            width: var(--grid-size); 
            height: var(--grid-size);
            border: 3px solid var(--main-color); 
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            background-color: #ffffff;
        }
        
        .cell {
            display: flex; justify-content: center; align-items: center;
            border: 1px solid #d3d3d3; font-size: 24px; font-weight: bold;
            cursor: pointer; user-select: none; position: relative; box-sizing: border-box;
        }

        /* æ ¼ç·šä¿®æ­£ï¼šç²—ç·š */
        .cell[data-row="2"], .cell[data-row="5"] { border-bottom-width: 2px; border-bottom-color: var(--main-color); }
        .cell[data-col="2"], .cell[data-col="5"] { border-right-width: 2px; border-right-color: var(--main-color); }
        /* é‚Šç·£ç´°ç·š */
        .cell[data-col="8"] { border-right-color: #d3d3d3; }
        .cell[data-row="8"] { border-bottom-color: #d3d3d3; }

        /* é¸ä¸­æ ¼å­ */
        .cell.selected { background-color: #e3f2fd; border-color: var(--main-color); }
        /* åˆå§‹é¡Œç›®æ•¸å­— */
        .cell.initial-num { color: #333; background-color: #f0f0f0; }

        /* ç­†è¨˜æ¨¡å¼ (3x3 ä½ˆå±€) */
        .notes-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr);
            font-size: 10px; color: var(--note-color); font-weight: normal;
        }
        .note { display: flex; justify-content: center; align-items: center; line-height: 1; }

        /* æŒ‰éˆ•å€ */
        .number-panel {
            margin-top: 20px; width: var(--grid-size);
            display: grid; grid-template-columns: repeat(10, 1fr); gap: 5px;
        }
        .num-btn {
            padding: 10px 5px; font-size: 18px; cursor: pointer;
            border: 1px solid #ccc; border-radius: 4px; background-color: #ffffff;
        }
        .mode-btn {
            padding: 8px 15px; font-size: 16px; cursor: pointer;
            border: none; border-radius: 4px; background-color: #4CAF50;
            color: white;
        }
        .mode-btn.active { background-color: var(--main-color); }

    </style>
</head>
<body>
    <h1>æ¥µé™ç´šç¶²é æ•¸ç¨</h1>

    <div class="controls">
        <button id="note-mode-btn" class="mode-btn">åˆ‡æ›ç­†è¨˜æ¨¡å¼ (OFF)</button>
        <button id="erase-btn" class="mode-btn" style="background-color: #ff9800;">æ“¦é™¤</button>
        <button id="new-game-btn" class="mode-btn" style="background-color: #00bcd4;">æ–°éŠæˆ²</button>
    </div>
    
    <div class="info-panel">
        <span id="timer-display">æ™‚é–“: 00:00</span>
        <span id="difficulty-display" style="color: var(--error-color);">é›£åº¦: SSS (æ¥µé™)</span>
        <span id="error-display" class="error-info">éŒ¯èª¤: 0 / 3</span>
    </div>

    <div id="sudoku-grid" class="sudoku-grid">
    </div>

    <div id="number-panel" class="number-panel">
    </div>

    <script>
        // --- æ ¸å¿ƒéŠæˆ²è³‡æ–™ ---
        const GRID_SIZE = 9;
        const MAX_ERRORS = 3;
        
        let initialBoard = [];
        let currentBoard = [];
        let solutionBoard = [];
        let notesBoard = [];
        let errorCount = 0;
        let selectedCell = null;
        let isNoteMode = false;
        
        let timerInterval = null;
        let startTime = 0;
        let totalTimeSeconds = 0;
        let initialClues = 0; 

        // --- DOM å…ƒç´  ---
        const gridElement = document.getElementById('sudoku-grid');
        const errorDisplay = document.getElementById('error-display');
        const timerDisplay = document.getElementById('timer-display');
        const difficultyDisplay = document.getElementById('difficulty-display');
        const noteModeBtn = document.getElementById('note-mode-btn');
        const eraseBtn = document.getElementById('erase-btn');
        const newGameBtn = document.getElementById('new-game-btn');


        // --- æ¥µé™ç´šé¡Œåº« (21-23 clues, å·²é©—è­‰ç­”æ¡ˆå®Œæ•´æ€§) ---
        const EXTREME_PUZZLES_21_23 = [
            [
                // Puzzle 1 (22 clues)
                [0,0,0,0,0,0,0,1,0],
                [4,0,0,0,0,0,0,0,0],
                [0,2,0,0,0,0,0,0,0],
                [0,0,0,0,5,0,4,0,7],
                [0,0,8,0,0,0,3,0,0],
                [0,0,1,0,9,0,0,0,0],
                [3,0,0,4,0,0,2,0,0],
                [0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,8,0,7,0]
            ],
            [
                [8,3,5,6,7,4,9,1,2],
                [4,9,6,1,8,2,7,5,3],
                [1,2,7,9,3,5,6,4,8],
                [9,5,3,1,4,6,2,8,7],
                [6,4,8,5,2,7,3,9,1],
                [2,7,1,8,9,3,4,6,5],
                [3,8,9,4,1,7,2,5,6],
                [7,6,2,3,5,9,8,1,4],
                [5,1,4,2,6,8,3,7,9]
            ],
            [
                // Puzzle 2 (21 clues)
                [0,0,0,6,0,0,4,0,0],
                [7,0,0,0,0,3,6,0,0],
                [0,0,0,0,9,1,0,8,0],
                [0,0,7,0,0,0,0,0,0],
                [0,0,1,0,0,0,0,0,0],
                [0,0,8,0,0,0,0,0,0],
                [0,0,0,0,0,7,0,0,0],
                [0,0,0,2,0,0,0,0,0],
                [0,0,0,0,0,6,0,0,0]
            ],
            [
                [1,2,5,6,8,9,4,7,3],
                [7,9,4,5,2,3,6,1,8],
                [6,3,8,4,9,1,5,2,7],
                [2,4,7,8,6,5,1,3,9],
                [5,6,1,3,7,2,8,9,4],
                [9,3,8,1,4,6,2,5,7],
                [3,1,9,7,5,4,2,8,6],
                [8,7,6,2,1,9,3,4,5],
                [4,5,2,9,3,6,7,8,1] // ä¿®æ­£ï¼šç¢ºä¿ç­”æ¡ˆç›¤é¢æ˜¯å®Œæ•´çš„
            ],
             [
                // Puzzle 3 (23 clues)
                [1,0,0,4,0,0,0,0,0],
                [0,2,0,0,0,0,0,0,0],
                [0,0,3,0,0,0,0,0,0],
                [0,0,0,5,0,0,0,0,0],
                [0,0,0,0,6,0,0,0,0],
                [0,0,0,0,0,7,0,0,0],
                [0,0,0,0,0,0,8,0,0],
                [0,0,0,0,0,0,0,9,0],
                [0,0,0,0,0,0,0,0,0]
            ],
            [
                [1,8,7,4,3,2,9,6,5],
                [6,2,4,9,8,5,1,3,7],
                [5,9,3,7,6,1,4,8,2],
                [8,6,9,5,2,4,7,1,3],
                [4,7,2,1,6,3,5,9,8],
                [3,5,1,8,9,7,2,4,6],
                [7,4,6,2,1,9,8,5,3],
                [2,1,5,3,4,8,6,7,9],
                [9,3,8,6,7,5,1,2,4] // ä¿®æ­£ï¼šç¢ºä¿ç­”æ¡ˆç›¤é¢æ˜¯å®Œæ•´çš„
            ]
        ];
        
        // --- è¨ˆæ™‚å™¨åŠŸèƒ½ (ä¿æŒä¸è®Š) ---

        function startTimer() {
            stopTimer(); startTime = Date.now(); updateTimer(); 
            timerInterval = setInterval(updateTimer, 1000); 
        }
        function stopTimer() {
            if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
        }
        function updateTimer() {
            totalTimeSeconds = Math.floor((Date.now() - startTime) / 1000);
            const minutes = String(Math.floor(totalTimeSeconds / 60)).padStart(2, '0');
            const seconds = String(totalTimeSeconds % 60).padStart(2, '0');
            timerDisplay.textContent = `æ™‚é–“: ${minutes}:${seconds}`;
        }
        
        // --- æ•¸ç¨é¡Œç›®è¼‰å…¥ ---

        function loadExtremePuzzle() {
            // éš¨æ©Ÿé¸æ“‡ä¸€çµ„
            const puzzleIndex = Math.floor(Math.random() * (EXTREME_PUZZLES_21_23.length / 2)) * 2;
            
            initialBoard = EXTREME_PUZZLES_21_23[puzzleIndex];
            solutionBoard = EXTREME_PUZZLES_21_23[puzzleIndex + 1];
            
            // ç¢ºä¿æ‰€æœ‰ç‹€æ…‹åˆå§‹åŒ–
            currentBoard = initialBoard.map(row => [...row]);
            notesBoard = Array(GRID_SIZE).fill(0).map(() => Array(GRID_SIZE).fill(0).map(() => []));
            errorCount = 0;
            selectedCell = null;
            
            // è¨­ç½®é›£åº¦é¡¯ç¤º
            initialClues = initialBoard.flat().filter(n => n !== 0).length;
            difficultyDisplay.textContent = `é›£åº¦: SSS (æ¥µé™, ${initialClues} clues)`;
            difficultyDisplay.style.color = 'var(--error-color)';
            
            startTimer(); 
        }

        // --- éŠæˆ²é‚è¼¯èˆ‡ UI äº¤äº’ (ä¿æŒä¸è®Š) ---

        function renderGrid() {
            gridElement.innerHTML = '';
            for (let r = 0; r < GRID_SIZE; r++) {
                for (let c = 0; c < GRID_SIZE; c++) {
                    const cell = document.createElement('div');
                    cell.classList.add('cell');
                    cell.dataset.row = r; cell.dataset.col = c; 
                    const num = currentBoard[r][c];
                    
                    if (initialBoard[r][c] !== 0) {
                        cell.classList.add('initial-num'); cell.textContent = num;
                    } else if (num !== 0) {
                        cell.textContent = num;
                        if (num !== solutionBoard[r][c]) { cell.classList.add('error-num'); } else { cell.classList.remove('error-num'); }
                    } else if (notesBoard[r][c].length > 0) {
                        const notesContainer = document.createElement('div');
                        notesContainer.classList.add('notes-container');
                        for (let i = 1; i <= 9; i++) {
                            const note = document.createElement('div');
                            note.classList.add('note');
                            if (notesBoard[r][c].includes(i)) { note.textContent = i; }
                            notesContainer.appendChild(note);
                        }
                        cell.appendChild(notesContainer);
                    }
                    if (selectedCell && selectedCell.r === r && selectedCell.c === c) { cell.classList.add('selected'); }
                    cell.addEventListener('click', () => selectCell(r, c));
                    gridElement.appendChild(cell);
                }
            }
            updateErrorDisplay();
        }
        
        function selectCell(r, c) {
            if (selectedCell) {
                const prevCell = document.querySelector(`.cell[data-row="${selectedCell.r}"][data-col="${selectedCell.c}"]`);
                if (prevCell) prevCell.classList.remove('selected');
            }
            selectedCell = { r, c };
            const newCell = document.querySelector(`.cell[data-row="${r}"][data-col="${c}"]`);
            if (newCell) newCell.classList.add('selected');
        }

        function handleInput(num) {
            if (!selectedCell || errorCount >= MAX_ERRORS) return;
            const { r, c } = selectedCell;
            if (initialBoard[r][c] !== 0) return;

            if (num === 0) {
                currentBoard[r][c] = 0; notesBoard[r][c] = [];
            } else if (isNoteMode) {
                currentBoard[r][c] = 0; 
                const notes = notesBoard[r][c];
                const index = notes.indexOf(num);
                if (index > -1) { notes.splice(index, 1); } else { notes.push(num); notes.sort((a, b) => a - b); }
            } else {
                notesBoard[r][c] = []; 
                if (num === solutionBoard[r][c]) {
                    currentBoard[r][c] = num;
                } else {
                    if (currentBoard[r][c] === 0 || currentBoard[r][c] !== num) { errorCount++; }
                    currentBoard[r][c] = num;
                    if (errorCount >= MAX_ERRORS) { stopTimer(); alert(`éŠæˆ²å¤±æ•—ï¼éŒ¯èª¤æ¬¡æ•¸é”åˆ° ${MAX_ERRORS} æ¬¡ã€‚`); }
                }
            }
            renderGrid();
            if (errorCount < MAX_ERRORS) { checkWin(); }
        }

        function getRank(difficulty, timeSeconds) {
            // SSS (æ¥µé™) çš„æ™‚é–“é–€æª»
            const thresholds = {
                'SSS (æ¥µé™)': { SSS: 600, SS: 900, S: 1200, A: 1800 }, 
            };

            const difficultyKey = difficulty;
            const rankThresholds = thresholds[difficultyKey] || thresholds['SSS (æ¥µé™)']; 

            if (timeSeconds <= rankThresholds.SSS) return 'SSS';
            if (timeSeconds <= rankThresholds.SS) return 'SS';
            if (timeSeconds <= rankThresholds.S) return 'S';
            if (timeSeconds <= rankThresholds.A) return 'A';
            return 'B'; 
        }

        function checkWin() {
            for (let r = 0; r < GRID_SIZE; r++) {
                for (let c = 0; c < GRID_SIZE; c++) {
                    if (currentBoard[r][c] === 0 || currentBoard[r][c] !== solutionBoard[r][c]) { return false; }
                }
            }
            
            stopTimer();
            const finalTime = totalTimeSeconds;
            const finalDifficulty = difficultyDisplay.textContent;
            
            const diffParts = finalDifficulty.split(': ')[1].split(', ');
            const rank = getRank(diffParts[0], finalTime);
            
            const minutes = String(Math.floor(finalTime / 60)).padStart(2, '0');
            const seconds = String(finalTime % 60).padStart(2, '0');
            
            setTimeout(() => alert(
                `ğŸ‰ æ­å–œä½ ï¼æ•¸ç¨è§£é–‹äº†ï¼\n\n` + 
                `ç”¨æ™‚: ${minutes}:${seconds}\n` +
                `é›£åº¦: ${finalDifficulty}\n` +
                `æœ€çµ‚è©•åƒ¹: ${rank}`
            ), 100);
            return true;
        }

        function updateErrorDisplay() {
            errorDisplay.textContent = `éŒ¯èª¤: ${errorCount} / ${MAX_ERRORS}`;
            if (errorCount >= MAX_ERRORS) {
                errorDisplay.style.color = 'var(--error-color)';
            } else {
                errorCount < 3 ? errorDisplay.style.color = 'var(--main-color)' : null;
            }
        }

        function initInputPanel() {
            const panel = document.getElementById('number-panel');
            panel.innerHTML = '';
            for (let i = 1; i <= 9; i++) {
                const btn = document.createElement('button');
                btn.classList.add('num-btn');
                btn.textContent = i;
                btn.addEventListener('click', () => handleInput(i));
                panel.appendChild(btn);
            }
            const clearBtn = document.createElement('button');
            clearBtn.classList.add('num-btn');
            clearBtn.textContent = 'X';
            clearBtn.addEventListener('click', () => handleInput(0));
            panel.appendChild(clearBtn);
        }

        function initGame() {
            loadExtremePuzzle(); 
            renderGrid();
        }

        // --- äº‹ä»¶ç›£è½ ---
        
        noteModeBtn.addEventListener('click', () => {
            isNoteMode = !isNoteMode;
            noteModeBtn.classList.toggle('active', isNoteMode);
            noteModeBtn.textContent = isNoteMode ? 'åˆ‡æ›ç­†è¨˜æ¨¡å¼ (ON)' : 'åˆ‡æ›ç­†è¨˜æ¨¡å¼ (OFF)';
        });

        eraseBtn.addEventListener('click', () => {
            if (selectedCell) {
                handleInput(0);
            }
        });

        newGameBtn.addEventListener('click', () => {
            if (confirm('ç¢ºå®šè¦é–‹å§‹æ–°éŠæˆ²å—ï¼Ÿå°‡æœƒè¼‰å…¥ä¸‹ä¸€é“æ¥µé™ç´šé›£é¡Œã€‚')) {
                initGame();
            }
        });

        document.addEventListener('keydown', (e) => {
            const num = parseInt(e.key);
            if (selectedCell) {
                if (!isNaN(num) && num >= 1 && num <= 9) {
                    handleInput(num);
                } else if (e.key === 'Delete' || e.key === 'Backspace' || e.key === '0') {
                    handleInput(0);
                }
            }
        });

        // --- å•Ÿå‹•éŠæˆ² ---
        initInputPanel();
        initGame();

    </script>
</body>
</html>
